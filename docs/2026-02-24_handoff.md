# 2026-02-24 Handoff

## 1) 오늘 작업 요약
- AI 뉴스 생성 파이프라인에서 레퍼런스 수집/검증/차단 게이트를 강화했습니다.
- `gemini-3-flash-preview` 기반으로 모델 전환을 적용하고, 실패 원인 비교 로그를 남기도록 추가했습니다.
- `AI_NEWS_PARSE_FALLBACK` 복구 체인(JSON repair 재시도)을 추가했습니다.

## 2) 오늘 반영한 핵심 변경
### A. 레퍼런스 수집/검증 강화
- RSS 링크 파싱 안정화(링크 추출 누락 버그 수정).
- top feed fallback(`keyword_filter_empty_fallback_to_top_feed`)은 생성용 레퍼런스 풀에서 제외.
- 감정별 키워드 + 동의어 확장 쿼리로 수집 범위 확대.

### B. 생성/게이트 로직
- 모델 출력 파싱 허용 범위를 확장(`items/articles/news/results/data`, 필드 alias 대응).
- weak-grounding 게이트 보정(오탐 감소) 및 레퍼런스 URL 정규화(`oc` 제거 등).
- parse 실패 시 JSON repair 재호출 후 재파싱하는 복구 체인 추가.

### C. 모델/운영 로그
- 뉴스 생성 모델을 `gemini-3-flash-preview`로 고정.
- 모델 결과 비교 로그(JSONL) 추가:
  - 파일: `server/data/ai_news_model_compare.jsonl`
  - 항목: model, status(success/blocked/fallback/error), reasonCode, latency, keywords, issueFetches
- parse 실패 상세 로그(JSONL) 추가:
  - 파일: `server/data/ai_news_parse_failures.jsonl`

## 3) 오늘 확인된 핵심 이슈(중요)
1. `AI_NEWS_MODEL_ERROR` 원인
- 실시간 API 미지원이 아니라, `gemini-3-flash-preview` 과부하(503 Service Unavailable/high demand) 케이스 확인.

2. **여전히 실제 기사를 충분히 반영하지 못하고 임시 기사로 저장되는 경우가 남아 있음**
- 사용자 체감: “실제 기사 기반이 아닌 임시 기사 작성”.
- 코드상 차단/폴백 사유:
  - `AI_NEWS_MODEL_ERROR` / `AI_NEWS_MODEL_TIMEOUT`
  - `AI_NEWS_PARSE_FALLBACK`
  - `AI_NEWS_REFERENCE_WEAK_GROUNDING`
- 즉, 레퍼런스는 수집되지만 생성 품질/결속도/가용성 조건에서 통과 실패 시 임시 기사로 내려감.

## 4) 검증 메모
- `npm run typecheck` 통과.
- `/api/admin/ai/news-health`에서 `model=gemini-3-flash-preview` 확인.
- 비교 로그 파일 생성/적재 확인.
- 다만 serenity 등에서 시간대에 따라 모델 과부하 및 weak-grounding 차단이 재현됨.

## 5) 내일 첫 작업 (사용자 요청 기준 P0)
### P0-1. 상태 문구 노출
- UI 토스트/상태영역에 아래 문구를 조건부 표시:
  - **"과부하로 백업 모델 사용 중"**
- 조건:
  - 서버가 primary 모델 실패 후 fallback 모델을 사용한 경우.
- 구현 포인트:
  - 서버 응답에 `modelUsed`/`fallbackModelUsed` 또는 `degradedMode` 플래그 노출.
  - 클라이언트(`client/src/pages/emotion.tsx`)에서 플래그 감지 후 사용자 메시지 표기.

### P0-2. “실제 기사 반영 실패” 개선 계속
- 목표: 임시 기사 저장 비율 감소.
- 우선순위:
1. model timeout/overload 재시도 정책 추가 조정(백오프/시도 횟수).
2. weak-grounding 프롬프트/판정 튜닝(실제 레퍼런스 핵심어 결속 강제 + 오탐 감소).
3. parse-fallback 로그 기반 후처리 규칙 보강(JSON repair 규칙 추가).

## 6) 관련 파일(오늘 수정 중심)
- `server/routes.ts`
- `client/src/pages/emotion.tsx`
- `server/data/ai_news_model_compare.jsonl` (런타임 로그)
- `server/data/ai_news_parse_failures.jsonl` (런타임 로그)

## 7) 참고 문서
- `docs/2026-02-23_handoff.md`
- `docs/article_generation_contract_v1.md`
- `docs/article_generation_tickets_v1.md`
- `docs/article_generation_total_2026-02-23.md`
