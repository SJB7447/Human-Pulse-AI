# 2026-02-27 Handoff (KR/EN)

## 1) 오늘 작업 요약 / Summary
- 기자 페이지 기사 생성 기준을 `docs/article_generation_update_2026-02-27.md` 우선 정책으로 반영했습니다.
- Applied journalist-page generation behavior with `docs/article_generation_update_2026-02-27.md` as top priority.
- 초안 생성 게이트를 유사도 과차단에서 복붙 탐지 중심으로 전환해 창의적 재구성을 허용했습니다.
- Rebalanced draft gate from lexical overblocking to copy-detection-first, enabling creative reconstruction.
- 롱폼/짧은 모드 전환 시 발생하던 발행 게이트 오류를 수정했습니다.
- Fixed publish-gate issues during longform/short mode switching.
- 출처를 본문에서 분리하고 수정 불가한 별도 UI 카드로 통합했습니다.
- Removed source from body and unified immutable source-card UI.
- 섹션 단위 + 문단 단위 부분 재생성 기능을 추가했습니다.
- Added section-level and paragraph-level partial regeneration.
- 관리자 운영지표에 7일/30일 추세와 AI News reasonCode 집계를 추가했습니다.
- Added 7d/30d trends and AI News reasonCode aggregation to admin ops metrics.
- 문서/프롬프트/코드 동기화 체크 스크립트를 추가했습니다.
- Added sync-check script for docs/prompt/code consistency.

## 2) 핵심 변경 / Key Changes
### A. Draft Prompt & Gate
- `server/services/articlePrompt.ts`
  - 듀얼모드 라벨(짧은 감성 브리핑/인터랙티브 심층 기사) 반영.
  - `titles[]` 후보 + 창의적 재구성 허용 규칙 추가.
- `server/routes.ts`
  - `AI_DRAFT_COPY_BLOCKED` 도입.
  - 도입/구조 유사도 과차단 로직을 제거하고 복붙 탐지 중심으로 재구성.
  - 생성 결과 `content`에서 `[출처]` 본문 삽입 제거, `sourceCitation` 별도 계약 유지.

### B. Journalist UX/Flow
- `client/src/pages/journalist.tsx`
  - 모드 설명/차단 메시지 모드별 정교화.
  - 롱폼→짧은 모드 전환 시 미디어 슬롯 carryover 정리.
  - 출처 카드(수정 불가) UI 추가, 본문과 분리.
  - AI 결과 도구 패널 제거.
  - 섹션 단위 재생성 + 실패 이슈 하이라이트.
  - 문단 단위 재생성 + 문단별 이슈 하이라이트.

### C. API/Client Contract
- `client/src/services/gemini.ts`
  - `regenerateDraftSection`, `regenerateDraftParagraph` 타입/메서드 추가.

### D. Ops/Telemetry/QA
- `server/routes.ts`
  - `aiDraftOps`, `aiNewsOps`에 `dailyTotals` 저장.
  - `trends.last7d`, `trends.last30d` 스냅샷 생성.
  - `aiNewsOps.reasonCodes` 집계/저장/복원/노출 추가.
- `client/src/pages/admin.tsx`
  - 7일/30일 요청/성공률 요약 카드 추가.
  - AI News 주요 reasonCode Top 집계 표시 추가.
- `scripts/ai_draft_regression.ts`
  - 출처 분리 계약 검증, 모드 전환 안정성, 문단 재생성 엔드포인트 가드 케이스 추가.
- `scripts/article_generation_sync_check.ts` (new)
  - 문서/프롬프트/코드 동기화 검사.

### E. Docs Sync
- `docs/article_generation_contract_v1.md`
  - Validation Gate를 Copy-Integrity 중심으로 최신화.
- `docs/article_generation_tickets_v1.md`
  - T3를 Copy-Integrity Gate 기준으로 최신화.

## 3) 주요 수정 파일 / Main Files Updated
- `server/services/articlePrompt.ts`
- `server/routes.ts`
- `client/src/pages/journalist.tsx`
- `client/src/services/gemini.ts`
- `client/src/pages/admin.tsx`
- `scripts/ai_draft_regression.ts`
- `scripts/article_generation_sync_check.ts` (new)
- `docs/article_generation_contract_v1.md`
- `docs/article_generation_tickets_v1.md`
- `package.json`
- `server/data/ai_draft_ops_metrics.json`

## 4) 검증 / Verification
- `npm run lint` 통과 (`npx tsc --noEmit`).
- `npm run test:article-sync` PASS.
- `npm run test:ai-draft` PASS (테스트 서버를 `ENABLE_AI_DRAFT_TEST_SCENARIO=1`로 기동 후 실행).

## 5) 다음 작업 / Next TODO
1. `scripts/ai_news_regression.ts`에 reasonCode/trend 검증 케이스 추가.
1. Add reasonCode/trend assertions to `scripts/ai_news_regression.ts`.
2. 관리자 대시보드에서 7d/30d 추세를 미니 차트로 시각화.
2. Add mini trend charts (7d/30d) in admin dashboard.
3. 문단 재생성 결과에 diff preview(변경 전/후)를 추가.
3. Add before/after diff preview for paragraph regeneration.
