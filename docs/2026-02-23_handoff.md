# 2026-02-23 Handoff

## 1) 오늘 작업 요약
- Emotion Mapping V3 기준으로 감정 카테고리/톤 규칙 반영 범위를 확장했습니다.
- 뉴스 페이지 AI 생성 실패(`AI_NEWS_MODEL_EMPTY`) 원인을 점검하고, 생성/저장/출력 흐름을 실제 운영 기준으로 정비했습니다.
- 관리자 페이지를 운영/통계와 기사관리 중심으로 대규모 UX 개선(탭, 앵커, 페이지네이션, 분류 편집, 겹침 이슈 보정)했습니다.
- 헤더 전역 뉴스 탭/드롭다운을 고정 내비게이션으로 유지하고 감정 카테고리 진입 동선을 일원화했습니다.

## 2) 반영된 핵심 변경
### A. 감정 매핑/프롬프트/생성 기준 정렬
- `HueBrief_Emotion_Mapping_V3`, `HueBrief_Unified_Spec` 기준을 코드/운영 문서와 동기화.
- 감정 키는 주제 제한이 아닌 "표현 강도/톤/밀도 조절" 레이어로 반영.
- 기사 생성 기준 문서를 통합 작성(프롬프트/금지사항/필수제한/백로그 포함).

### B. 뉴스 페이지 AI 생성 파이프라인
- `AI_NEWS_MODEL_EMPTY` 대응: 모델/키/설정 주입 경로 점검 및 실패 처리 개선.
- AI 뉴스 생성 시 텍스트형 기사 중심으로 출력되도록 UI/데이터 흐름 정리.
- 뉴스 목록/상세에서 이미지 박스 의존을 줄이고 텍스트 중심 카드 흐름 강화.

### C. 헤더/뉴스 내비게이션
- 헤더에 전역 `뉴스` 탭 추가.
- 감정 카테고리 드롭다운 제공(대표색/대표분야 병기).
- `스펙트럼` 대표 분야를 `(균형·다양성)`으로 수정 반영.

### D. 관리자 페이지 운영 개선
- `운영 체계/통계` vs `기사 관리` 탭 분리 및 탭 가시성 강화.
- 상단 앵커 바(KPI/차트/운영/AI지표) 추가 + 섹션 스크롤 이동.
- 기사 리스트 페이지네이션(10개/페이지) 및 컬러형 페이지네이션 UI 반영.
- 기사 감정/카테고리 수정 기능 확장(상세 팝업 기반), 운영 분류 정합성 정리.
- `GlobalScrollTop` 관리자 노출, HueBot과 위치 충돌 최소화.

### E. 앵커/고정 요소 충돌 수정
- 헤더 높이 반응형 이슈 대응:
  - 데스크톱 67px / 모바일 99px 기준을 하드코딩 고정값이 아닌 동적 측정으로 보정.
  - `ResizeObserver + requestAnimationFrame`으로 초기/리사이즈 시점 오차 완화.
- 하단 겹침 완화:
  - 관리자 하단 여유 공간(100px) 및 고정 버튼 오버레이 충돌 방지 구조 반영.

### F. 기사관리 감정 표시 가독성 보강
- 감정 셀을 2행 구조로 통일:
  - 1행: 감정명 + AI 아이콘(툴팁)
  - 2행: 대표 분야(1개)
- 해시태그/긴 문자열이 셀 밖으로 나가지 않도록 `break-words`/`overflow-wrap` 적용.

## 3) 오늘 확인/해결한 주요 오류
1. 뉴스 상단/헤더 가림 이슈
- 원인: fixed/sticky 기준점 불일치.
- 조치: 헤더-앵커-본문 오프셋 재계산 및 반응형 동기화.

2. AI 생성 실패 (`AI_NEWS_MODEL_EMPTY`)
- 원인: 모델/키/설정 경로 불일치 또는 빈 응답 처리 미흡.
- 조치: 설정 경로 점검 + 실패 사유 노출/재시도/폴백 동선 정비.

3. 관리자 하단 버튼 겹침
- 원인: fixed 버튼 오버레이 대비 문서 하단 실제 여백 부족.
- 조치: 하단 스페이서 및 패딩 보강, 관리자 전용 위치 보정.

4. 기사관리 테이블 깨짐
- 원인: 감정/카테고리 텍스트 길이 편차와 열 폭 부족.
- 조치: 열 너비 재조정 + 2행 통일 + 긴 텍스트 줄바꿈/클램프 적용.

## 4) 검증
- `npm run typecheck` 통과.
- `npm run lint` 통과.
- 주요 수동 확인:
  - 관리자 탭 전환/앵커 이동/페이지네이션 동작
  - 기사관리 감정 셀 렌더링(대표분야 1개 + AI 아이콘)
  - 헤더/앵커/스크롤탑 상대 위치

## 5) 내일 작업 TODO (요청 반영)
### P0. 뉴스 페이지 인터랙티브/카드 UI 사이즈 지정
- 카드/컨테이너/섹션별 기준 너비/높이/간격 토큰 정의.
- 데스크톱/태블릿/모바일 breakpoint별 카드 밀도 재설계.
- 카드 제목/요약/메타의 줄수 제한 및 overflow 정책 확정.

### P0. 뉴스 페이지 오류 수정(회귀 포함)
- 헤더/탭/고정요소 겹침 재점검.
- 감정 필터/정렬/검색 조합 시 레이아웃 깨짐 여부 점검.
- AI 생성 실패 케이스별 사용자 메시지/재시도 UX 통일.

### P1. 뉴스 상세 컨테이너 하단 버튼 기능 구현
- 하단 액션 버튼별 실제 기능 연결(좋아요/저장/공유/다음콘텐츠/복귀 등 확정 필요).
- 버튼 상태(hover/active/loading/disabled) 및 접근성 라벨 정리.
- 상세 → 리스트 복귀 시 스크롤 맥락 유지 로직 검증.

### P1. 테스트 보강
- 뉴스 페이지 E2E 핵심 시나리오 작성:
  - 카드 진입 → 상세 → 하단 버튼 액션 → 복귀.
- 회귀 체크리스트 문서화(모바일 포함).

## 6) 내일 시작 체크리스트
1. 뉴스 페이지 컴포넌트 트리/스타일 토큰 현황 점검.
2. 하단 버튼 기능 요구사항 최종 확정(액션별 API/상태).
3. 카드/상세 레이아웃 기준치 확정 후 일괄 적용.
4. 인터랙션/오류 회귀 테스트 실행.

## 7) 참고 문서
- `docs/2026-02-20_handoff.md`
- `docs/HueBrief_Emotion_Mapping_V3.md`
- `docs/HueBrief_Unified_Spec.md`
- `docs/article_generation_master_2026-02-23.md`
- `docs/article_generation_current_baseline_2026-02-23.md`

## 8) 배포 장애 대응 기록 (2026-02-23)
### A. 증상
- Vercel 배포 후 감정 뉴스 페이지(`/emotion/*`)에서 기사 로딩 실패.
- 브라우저 콘솔/네트워크에서 `/api/news/:emotion`, `/api/articles?all=true`가 `500`.
- 초기에는 JSON 파싱 에러(`Unexpected token '<'`)가 먼저 관찰됨.

### B. 원인 분석
1. 라우팅 오설정
- `vercel.json`에서 `/api/(.*)`를 `/api/index.js`로 rewrite하여 일부 요청이 SPA `index.html`로 떨어짐.
- 결과: API가 JSON 대신 HTML 응답 -> 프론트에서 JSON 파싱 실패.

2. Vercel Function 모듈 로딩 실패
- 로그: `ERR_MODULE_NOT_FOUND: Cannot find module '/var/task/server/routes' imported from /var/task/api/index.js`.
- 원인: 서버리스 런타임에서 `api/index.ts -> server/routes` import 체인 해석 실패(ESM 경로/패키징 차이).

### C. 적용한 조치
1. API rewrite 수정
- `vercel.json`의 API destination을 `/api/index`로 변경.

2. 프론트 API fetch 안정화
- `client/src/hooks/useNews.ts`
  - 304 응답 시 cache-busting 재시도.
  - non-JSON 응답 감지 시 명시적 오류 처리.

3. 서버 read API 안전 폴백
- `server/routes.ts`
  - `/api/news`, `/api/news/:emotion`, `/api/articles`에서 예외 발생 시 `200 + []` 반환하도록 방어.

4. 서버리스 bootstrap 폴백 추가
- `api/index.ts`
  - `registerRoutes` 로딩 실패 시 즉시 500을 내지 않고, fallback read routes를 등록.
  - fallback 라우트는 Supabase 직접 조회 기반으로 최소 기능 제공.
  - `/api/health`에 `mode(full|fallback)` 및 `routeBootstrapError` 노출해 운영 진단 가능하게 함.

### D. 관련 커밋
- `b79ad0e`: vercel rewrite + news fetch JSON handling 강화
- `15f3c63`: news/article read API 실패 시 안전 폴백
- `dfe9d12`: Vercel API import ESM-safe 보강
- `5e86342`: server module load 실패 시 API fallback routes 등록

### E. 검증 체크
- 배포 후 확인 URL
  - `/api/health`
  - `/api/news/vibrance`
  - `/api/articles?all=true`
- 정상 기준
  - 상태코드 `200` 또는 캐시 `304` (정상 캐시)
  - 응답 본문 JSON
  - 감정 페이지에서 `Unable to load news data` 미발생

### F. 원인/대안/영향 정리
- cause: Vercel 서버리스 환경에서 API 엔트리 import/rewrites가 로컬과 다르게 동작.
- workaround: API bootstrap 실패 시 fallback read routes로 즉시 전환.
- impact: 최소 기능(기사 조회)은 유지, 단 fallback 모드에서는 일부 고급 서버 기능이 제한될 수 있음.

### G. 다음 액션 (권장)
- Vercel 전용 API 엔트리를 분리해 `server/routes.ts` 의존도를 줄인 경량 라우트 구조로 정리.
- fallback 모드에서도 운영자가 즉시 인지하도록 `/api/health` 상태를 관리자 UI에 노출.
